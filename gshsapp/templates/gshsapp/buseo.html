{% extends 'base.html' %}
{% block content %}
{% load humanize %}
{% load static %}

<div class="row">
    <div class="col-md-2">
        <div class="card box_shadow">
            <div class="card-header bg-secondary text-light text-center">
              <h6>ë¶€ì„œë³„</h6>  
            </div>
            <div class="card-body">
                <ul>
                {% for buseo in buseos %}
                    <li>{{ buseo.hosil }}</li>
                {% endfor %}
                </ul>            
            </div>
        </div>       
    </div>
    
    <div class="col-md-10">    
      <div>
        <span style="padding-left: 20px;">ğŸ™„ ë¶€ì›ë“¤ <span>
      </div>  
      <table class="table text-center mt-2">
          <thead class="table-secondary">
            <tr>
              <th scope="col">êµ¬ë§¤ì¼</th>
              <th scope="col">êµ¬ë¶„</th>
              <th scope="col">ì„±ëª…</th>
              <th scope="col">ì œì¡°ì‚¬</th>
              <th scope="col">ëª¨ë¸ëª…</th>
              <th scope="col">IP</th>
              <th scope="col">ë¹„ê³ </th>                    
              <th scope="col"></th>                    
            </tr>
          </thead>
          <tbody id="buwonInsert">
            {% for gigi in members %}
            {% if gigi.user %}
            <tr>
              <td>{{ gigi.buyproduct.buydate|date:"Y-m-d" }}</td>
              <td>{{ gigi.buyproduct.gubun }}</td>
              <td>{{ gigi.user.name }}</td>       
              <td>{{ gigi.buyproduct.company }}</td>
              <td>{{ gigi.buyproduct.model }}</td>
              <td>{{ gigi.ip }}</td>
              <td>{{ gigi.bigo }}</td>                
              <td><span class="buwon-update" data-buseo="{{buseogubun}}" type="button" data-url="{% url 'gshsapp:gigi_buseo_update' pk=gigi.id %}" title="ìˆ˜ì •í•˜ê¸°">ğŸ“</span></td>                
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
        
        <div class="mt-5">
          <span style="padding-left: 20px;">ğŸ¦‰ ì •ë³´ê¸°ìì¬ <span>
        </div>
        <table class="table text-center mt-2">
          <thead class="table-secondary">
            <tr>
              <th scope="col">êµ¬ë§¤ì¼</th>
              <th scope="col">êµ¬ë¶„</th>
              <th scope="col">ì œì¡°ì‚¬</th>
              <th scope="col">ëª¨ë¸ëª…</th>
              <th scope="col">ìƒ‰ìƒ</th>
              <th scope="col">IP</th>
              <th scope="col">ë¹„ê³ </th>                    
              <th scope="col"></th>                    
            </tr>
          </thead>
          <tbody id="gigiInsert">
            {% for gigi in members %}
            {% if not gigi.user %}
            <tr>
              <td>{{ gigi.buyproduct.buydate|date:"Y-m-d" }}</td>
              <td>{{ gigi.buyproduct.gubun }}</td>        
              <td>{{ gigi.buyproduct.company }}</td>
              <td>{{ gigi.buyproduct.model }}</td>
              <td>{{ gigi.color }}</td>
              <td>{{ gigi.ip }}</td>
              <td>{{ gigi.bigo }}</td>
              <td><span class="buseogigi-update" data-buseo="{{buseogubun}}" type="button" data-url="{% url 'gshsapp:gigi_buseo_update' pk=gigi.id %}" title="ìˆ˜ì •í•˜ê¸°">ğŸµ</span></td>                                
            </tr>
            {% endif %}
            {% endfor %}
          </tbody> 
        </table>
        <br><br><hr>
        <div class="mt-5">
          <span style="padding-left: 20px;">ğŸ· ì†Œëª¨í’ˆêµì²´ <span><span style="margin-left:20px;font-size: 0.9rem; font-weight: bold;color:orangered;">[ ì´ì•¡ : &#8361; {{changeTotalCost.changeTotal__sum|intcomma}} ]</span>
        </div>
        <table class="table text-center mt-2">
          <thead class="table-secondary">
            <tr>
              <th scope="col">ë‚ ì§œ</th> 
              <th scope="col">ì œì¡°ì‚¬</th>
              <th scope="col">ëª¨ë¸ëª…</th>
              <th scope="col">ë¶€í’ˆ</th>
              <th scope="col">ê°œìˆ˜</th>
              <th scope="col">ë¹„ìš©</th>
              <th scope="col">ë¹„ê³ </th>                    
              <th scope="col">ì‚¬ì§„</th>                    
            </tr>
          </thead>    
          <tbody>     
            {% for gigi in changes %}
            {% with gubunchange=gigi.change_photo.all %}
            <tr {% if gubunchange %} class="gigi-change" {% else %} {% endif %}>
              <td>{{ gigi.date|date:"Y-m-d" }}</td>        
              <td>{{ gigi.gigiinfo.buyproduct.company }}</td>
              <td>{{ gigi.gigiinfo.buyproduct.model }}</td>
              <td>{{ gigi.gubun }}</td>
              <td>{{ gigi.count }}</td>
              <td>&#8361;{{ gigi.cost|intcomma }}</td>
              <td title="{{gigi.bigo}}">{{ gigi.bigo|truncatechars:10 }}</td>
              <td>
                {% if gubunchange %}                
                <span data-gubun="change" data-value="{{ gigi.id }}" style="font-weight: bold;font-size:0.8rem;color:white;background-color:#495057;padding:3px 7px;border-radius: 5px;">ë³´ê¸°</span>
                {% endif %}
              </td>               
            </tr>
            
            {% if gubunchange %}
            <tr class="photoshows">
              <td colspan="8">
                <ul class="gallery"> 
                  {% for c in gubunchange %}           
                  <li>
                    <a class="link-photo lb-initialized" href="{{ c.image.url }}" data-lightbox="img"><img src="{{ c.image.url }}" style="width:auto; max-height:150px;"></a>
                  </li>
                  {% endfor %}   
                </ul>                
              </td>
            </tr>
            {% endif %}
          {% endwith %}          
        {% endfor %}
          </tbody> 
        </table>        

        <div class="mt-5">
          <span style="padding-left: 20px;">ğŸ¦Š ì†Œëª¨í’ˆìˆ˜ë¦¬ <span>
            <span style="margin-left:20px;font-size: 0.9rem; font-weight: bold;color:orangered;">[ ì´ì•¡ : &#8361; {{repairTotalCost.cost__sum|intcomma}} ]</span>  
        </div>
        <table class="table text-center mt-2">
          <thead class="table-secondary">
            <tr>
              <th scope="col">êµ¬ë§¤ì¼</th> 
              <th scope="col">ì œì¡°ì‚¬</th>
              <th scope="col">ëª¨ë¸ëª…</th>
              <th scope="col">ì›ì¸</th>
              <th scope="col">ê²°ê³¼</th>
              <th scope="col">ë¹„ìš©</th>
              <th scope="col">ë¹„ê³ </th> 
              <th scope="col">ì‚¬ì§„</th>                   
            </tr>
          </thead>  
          <tbody>             
            {% for gigi in repairs %}
            {% with gigi.repair_photo.all as gubunrepair %}
            <tr {% if gubunrepair %} class="gigi-repair" {% else %} {% endif %}>
              <td>{{ gigi.date|date:"Y-m-d" }}</td>        
              <td>{{ gigi.gigiinfo.buyproduct.company }}</td>
              <td>{{ gigi.gigiinfo.buyproduct.model }}</td>
              <td title="{{gigi.problem}}">{{ gigi.problem|truncatechars:7 }}</td>
              <td title="{{gigi.result}}">{{ gigi.result|truncatechars:5 }}</td>
              <td>&#8361;{{ gigi.cost|intcomma }}</td>
              <td title="{{gigi.bigo}}">{{ gigi.bigo|truncatechars:5 }}</td>    
              <td>
                {% if gubunrepair %}                
                <span data-gubun="repair" data-value="{{ gigi.id }}" style="font-weight: bold;font-size:0.8rem;color:white;background-color:#495057;padding:3px 7px;border-radius: 5px;">ë³´ê¸°</span>
                {% endif %}
              </td>                   
            </tr>
            {% if gubunrepair %}
            <tr class="photoshows">
              <td colspan="8">
                <ul class="gallery">   
                  {% for r in gubunrepair %}               
                  <li>
                    <a class="link-photo lb-initialized" href="{{ r.image.url }}" data-lightbox="img"><img src="{{ r.image.url }}" style="width:auto; max-height:150px;"></a>
                  </li>
                  {% endfor %}   
                </ul>
              </td>
            </tr>
            {% endif %}
          {% endwith %}
        {% endfor %} 
          </tbody> 
        </table>
    </div>
</div>

<div id="modal" class="modal-overlay">
  <div class="modal-window">
    <!-- <div class="gigi-update1">ìˆ˜ì •í•˜ê¸°</div> -->
    <div class="title">
      <div class="title_side"></div>
      <div> ìˆ˜ì •í•˜ê¸° </div>
      <div class="title_side">
          <span id="close_modal" class="material-icons-outlined">x</span>
      </div>
    </div>
    <div class="gigi-update2">
      <div class="content">

      </div>
    </div>
  </div>
</div>  

<script>  
  $(function(){    
    const lb = lightbox();        
    //csrf token
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }

    var csrftoken = getCookie('csrftoken');

    let togglebar = function(e){    
      e.preventDefault();
      e.stopPropagation();
      let check = $(this).next().css("display") == "none";
      let except = $(this).next();
      if(check)// ì—´ë¦´ë¶€ë¶„ì˜ displayê°€ noneìœ¼ë¡œ ë˜ì–´ìˆë‹¤ë©´, 
		  {
        $(this).next().show(); //ì—´ë¦´ë¶€ë¶„ì˜ displayë¥¼ blockìœ¼ë¡œ ë³€ê²½í•´ì£¼ê³ ,
        $('.photoshows').not(except).css('display','none'); //ê·¸ì™¸ì˜ ë‚´ìš©ë¶€ë¶„(.not() ìœ¼ë¡œ ì œì–´í•¨) ì€ displayë¥¼ noneìœ¼ë¡œ ì•ˆë³´ì´ê²Œ ë³€ê²½ì‹œí‚µë‹ˆë‹¤.
      }else {
        $(this).next().css('display','none');
      }
    };

    $('.gigi-repair, .gigi-change').on("click", togglebar); // ì‚¬ì§„ë³´ê¸°

    // ëª¨ë‹¬ 
    var loadBuwonForm = function () {       
        var btn = $(this);
        $.ajax({
            url: btn.attr("data-url"),
            type: 'get',
            dataType: 'json',
            // contentType: false, //contentType : false ë¡œ ì„ ì–¸ ì‹œ content-type í—¤ë”ê°€ multipart/form-dataë¡œ ì „ì†¡ë˜ê²Œ í•¨
            // processData: false, //processData : falseë¡œ ì„ ì–¸ ì‹œ formDataë¥¼ stringìœ¼ë¡œ ë³€í™˜í•˜ì§€ ì•ŠìŒ
            beforeSend: function () {
              $("#modal").show();
            },
            success: function (data) {
              $("#modal .content").html(data.html_form);               
            }
        });
    };      
    
    var saveForm = function () {
        // var form = $(this);
        var form = $("#form");
        $.ajax({
        url: form.attr("action"),
        data: form.serialize(),
        type: form.attr("method"),
        dataType: 'json',
        success: function (data) {
          if (data.form_is_valid) {  
            if (data.buwon) {         
                $("#buwonInsert").html(data.html_buseo);
              } else {
                $("#gigiInsert").html(data.html_buseo);
              }          
            $("#modal").hide();
          } else {
            $("#modal .content").html(data.html_form);
          } 
        }       
      });
    };

    // ë¶€ì› ë¡œë“œ
    $("#buwonInsert").on('click','.buwon-update',loadBuwonForm);
    $("#gigiInsert").on('click','.buseogigi-update',loadBuwonForm);
    $('#modal').on('click','.buseobutton', saveForm);

    $("#close_modal").click(function(){
      $("#modal").css("display", "none"); 
    });
   
// ì™¸ë¶€ì˜ì—­ í´ë¦­ì‹œ ë‹«ê¸°
    $(document).mouseup(function (e){
      var LayerPopup = $("#modal");
      if(LayerPopup.has(e.target).length === 0){
        $("#modal").css("display", "none");
      }
    });
    
});  
</script>
<!--ì‚¬ì§„ ëª¨ë‹¬-->
<script src="{% static 'js/lightbox.min.js' %}"></script>
<link href="{% static 'css/lightbox.min.css' %}" rel="stylesheet" >
{% endblock %}